# 🦊 LINE 智能記帳與提醒助手

## 🌟 專案簡介
這是一個結合 LINE Messaging API 與 PWA 前端的一站式生活助理。使用者可以透過 LINE 進行簡單的記帳和建立提醒，透過互動式選單快速選擇，並透過 Web App 查詢報表與管理任務。

### 🎯 產品特色
- 📱 無需安裝 App，直接使用 LINE 操作
- 💬 支援簡單指令輸入，操作直覺簡單
- 📊 提供視覺化報表與數據分析
- 🔔 智能提醒功能，支援重複提醒
- 🌐 同步 Web 介面，方便數據管理

## 📋 功能說明

### 1. 記帳功能
- 簡單指令記帳：直接輸入「早餐 -120」、「薪水 +30000」等
- **自然語言記帳**：支持多種口語化表達，如「今天午餐花了80元」、「昨天買衣服消費300」
- 互動式分類：回傳 Flex message 讓用戶點選支出類別
- 快速選單：提供常用分類快速選擇
- 支援多帳戶管理
- 視覺化確認：使用精美卡片呈現交易記錄結果
- **智能分類**：根據關鍵詞自動判斷交易類別（如「蔬菜」→「食品」類別）
- **日期識別**：支持「今天」、「昨天」、「週二」等多種日期表達方式

### 2. 提醒功能 ✅
- 自然語言建立：輸入「明天早上8點提醒我去健身」即可建立提醒
- 靈活設定：
  - 支援提前通知（如提前 30 分鐘提醒）
  - 支援重複週期（如每週一、每月 1 號等）
- 豐富的時間表達：
  - 相對時間：「今天」、「明天」、「後天」、「下週一」等
  - 時間描述：「早上」、「下午」、「晚上」配合具體時間點
  - 精確時間：「9點」、「14:30」等
- 提醒方式：LINE 訊息通知
- 提醒管理：可一鍵標記完成或刪除提醒
- 視覺化呈現：以卡片方式顯示提醒列表
- 詳細說明：查看 [提醒功能說明文檔](docs/reminder_feature.md)

### 3. 報表功能
- 視覺化圖表：
  - 收支比例圖
  - 分類支出分析
- 時間區段統計：
  - 本日/本週/本月
  - 自訂時間範圍
- 數據導出：
  - 支援 PDF 格式
  - 支援 Excel 格式

### 4. 快速選單功能 ✅
- 富選單操作：直接點擊選單即可選擇功能
- 分類功能：提供常用分類快速選擇
- 帳戶管理：快速切換常用帳戶
- 查詢入口：一鍵查詢各類報表

### 5. 自然語言查詢 ✅
- 支援多種查詢表達方式：「查詢本月支出」、「這個月花了多少錢」、「上個月收入」
- 時間範圍識別：
  - 相對時間：今天、昨天、本週、上週、本月、上月、今年、去年
  - 特定日期：「2023年10月」、「2023/12/30」
- 查詢類型：
  - 支出查詢：按時間、分類、帳戶查詢支出
  - 收入查詢：按時間、分類、帳戶查詢收入
  - 餘額查詢：查詢特定時間段或帳戶餘額
  - 總覽查詢：查看特定時間段的收支概況
- 分類與帳戶識別：自動識別查詢中提及的分類或帳戶
- 視覺化結果：以圖表形式呈現查詢結果，包括餅圖、柱狀圖等

### 6. Web 介面功能
- 帳戶總覽
- 詳細報表查詢
- 提醒任務管理
- 數據匯出功能

## 🛠 技術架構

### 後端技術
- Python 3.8+
- LINE Messaging API
- SQLite 資料庫

### 前端技術
- PWA (Progressive Web App)
- HTML5 + CSS3
- JavaScript (ES6+)
- Chart.js 圖表庫

## 📁 專案結構
```
linebot-assistant/
├── webhook.py                # LINE Webhook 處理程式
├── test_webhook.py           # 簡易測試腳本（無簽名驗證，僅開發環境使用）
├── test_webhook_with_signature.py # 完整測試腳本（含簽名驗證）
├── .env.example              # 環境變數範例
├── init_db.py                # 資料庫初始化腳本
├── Dockerfile                # Docker 容器配置
├── fly.toml                  # Fly.io 部署設定
├── requirements.txt          # Python 依賴
├── handlers/                 # 訊息處理器
│   ├── __init__.py
│   └── message_handler.py    # LINE 訊息處理器
├── parsers/                  # 文本解析器
│   ├── __init__.py
│   └── text_parser.py        # 基於規則的文本解析器
├── database/                 # 資料庫相關
│   ├── db_utils.py           # 資料庫工具類
│   └── schema.sql            # 資料庫結構
├── static/                   # PWA 前端頁面
│   ├── assets/               # 靜態資源
│   ├── css/                  # 樣式文件
│   ├── js/                   # JavaScript 文件
│   ├── templates/            # HTML 模板
│   ├── manifest.json         # PWA 配置
│   └── sw.js                 # Service Worker
└── README.md                 # 專案說明文件
```

## 🚀 快速開始

### 環境需求
- Python 3.8 或以上版本
- LINE Developers 帳號

### 安裝步驟

1. 複製專案並安裝依賴

```bash
git clone https://github.com/yourusername/linebot-assistant.git
cd linebot-assistant
pip install -r requirements.txt
```

2. 複製 `.env.example` 為 `.env` 並填入您的配置

```bash
cp .env.example .env
```

主要設定項目：
- LINE_CHANNEL_SECRET: 從 LINE Developers 取得的頻道密鑰
- LINE_CHANNEL_ACCESS_TOKEN: 從 LINE Developers 取得的存取權杖
- WEBHOOK_URL: 您的 Webhook URL

3. 初始化資料庫

```bash
python init_db.py
```

4. 啟動測試伺服器

```bash
python webhook.py
```

5. 使用 ngrok 或其他工具將本地服務暴露到公網

```bash
ngrok http 5000
```

6. 在 LINE Developers 控制台中設定 Webhook URL

### 測試 Webhook

本專案提供兩種測試腳本，以便在不同情境下測試 Webhook 功能：

1. **開發環境測試** (`test_webhook.py`)

```bash
# 設置開發環境模式
export FLASK_ENV=development  # Linux/macOS
set FLASK_ENV=development     # Windows
# 執行測試
python test_webhook.py
```

這個測試腳本特點：
- **無簽名驗證**：跳過 X-Line-Signature 驗證步驟
- **僅用於開發環境**：僅在 FLASK_ENV=development 時有效
- **使用測試用戶**：使用特殊的 test_user_id，無需真實 LINE 用戶
- **適用場景**：快速驗證 webhook 邏輯和資料處理流程

2. **完整測試** (`test_webhook_with_signature.py`)

```bash
python test_webhook_with_signature.py
```

這個測試腳本特點：
- **包含簽名驗證**：模擬真實 LINE 平台請求，計算並附加正確的 X-Line-Signature
- **適用於任何環境**：開發環境和生產環境都可使用
- **可測試多種訊息類型**：支援測試各種不同的 LINE 事件類型
- **適用場景**：最終部署前的完整功能測試

> 注意：在實際部署時，webhook 將始終驗證簽名。開發環境的無簽名測試只是為了簡化本地開發流程。

## 📝 使用說明

### 基本指令

使用者可以直接在聊天窗口中輸入以下指令：

- **選單指令**: 直接在聊天中輸入"選單"或點擊底部選單按鈕，即可獲取主選單
- **記帳指令**: 
  - 使用選單中的按鈕選擇記帳類型
  - 按照提示完成消費類別和金額輸入
- **查詢指令**: 
  - 使用選單中的查詢按鈕
  - 選擇需要查詢的時間範圍和類型
- **設定指令**: 使用選單中的設定按鈕進行個人預算和提醒設定

### 互動式選單

所有功能可通過 LINE 聊天機器人提供的互動式選單輕鬆完成，無需記憶複雜指令。

## 🧩 功能模組

本專案由以下主要模組組成：

### 核心模組
- **webhook.py**: 處理 LINE 平台的 Webhook 請求
- **db_manager.py**: 資料庫管理和操作
- **user_manager.py**: 用戶管理和認證

### 業務模組
- **accounting.py**: 記帳功能核心邏輯
- **command_handler.py**: 使用者命令處理和分發
- **menu_manager.py**: 互動選單生成和管理
- **query_processor.py**: 用戶查詢處理和資料統計 
- **notification.py**: 定時提醒和通知功能

### UI模組
- **flex_templates.py**: LINE Flex Message 卡片模板
- **carousel_generator.py**: 動態生成輪播式訊息

### 工具模組
- **utils.py**: 通用工具函數集合
- **config.py**: 配置管理
- **logger.py**: 日誌記錄

## 🤝 貢獻指南
歡迎提交 Pull Request 或提出 Issue。請確保：
1. 代碼符合 PEP 8 規範
2. 提交前進行測試
3. 更新相關文檔

## 📄 授權
MIT License

## 📞 聯絡方式
如有問題或建議，請透過以下方式聯絡：
- Email: [聯絡信箱]
- GitHub Issues: [專案 Issues 頁面]

## 🔄 使用流程

### 1. 初次使用
1. 加入LINE機器人為好友（掃描QR碼或LINE ID搜尋）
2. 發送「開始」或「選單」獲取主選單
3. 按照引導完成個人資料設定

### 2. 日常記帳
1. **自然語言記帳**：直接輸入日常用語，如「午餐花了80元」、「今天交通費25元」
2. **精確記帳**：從選單中選擇「記帳」，然後選擇交易類型（支出/收入）
3. 系統智能識別金額、類別和日期
4. 確認資訊並完成記帳

### 3. 設置提醒
1. **直接輸入**：「明天早上9點提醒我開會」、「每週一晚上8點提醒我健身」
2. **查看提醒**：輸入「查看提醒」或「我的提醒」
3. **管理提醒**：點擊提醒卡片上的「完成」或「刪除」按鈕

### 4. 查詢統計
1. 從選單中選擇「查詢」，或直接輸入「查詢本月支出」
2. 選擇時間範圍（今日/本週/本月/自訂）
3. 選擇查詢類型（支出/收入/結餘）
4. 查看圖表和明細統計

## 🔁 無縫更新功能

我們的LINE智能記帳與提醒助手提供**無痛更新機制**，讓您能夠獲得最新功能而無需進行任何複雜操作。

### 核心優勢
- ✅ **無需刪除好友**：保留您與機器人的好友關係，所有歷史數據完整保留
- ✅ **自動數據遷移**：系統會自動將您的記帳和提醒數據遷移到新版本
- ✅ **零用戶操作**：更新過程完全在後台進行，您不需要執行任何操作

### 更新時會發生什麼？
1. 當系統更新時，您會收到一條消息通知新功能的推出
2. 您的所有數據（包括記帳記錄、提醒、帳戶設置）都會自動遷移
3. 您可以立即開始使用新功能，無需任何設置或登入操作

### 如何確認更新狀態？
- 發送「版本」或「更新」指令，機器人會回覆當前的版本號和最近更新內容
- 您也可以在選單中的「更多功能」→「關於」中查看版本信息

這種無縫更新機制確保您始終使用最新、最安全的版本，同時保護您的所有歷史數據和設置。

## 📝 自然語言處理能力

本機器人具備強大的自然語言處理能力，能夠從用戶的日常對話中提取關鍵信息：

### 記帳指令：
- 「午餐吃飯花了80元」→ 識別為：支出 80元，項目「午餐吃飯」，類別「飲食」
- 「昨天買了一件衣服300塊」→ 識別為：支出 300元，項目「衣服」，類別「購物」，日期「昨天」
- 「上週三從公司收到5000元薪資」→ 識別為：收入 5000元，項目「薪資」，日期「上週三」

### 提醒指令：
- 「提醒我明天早上8點去健身」→ 設置第二天早上8:00的健身提醒
- 「下週一下午3點提醒我開會」→ 設置下週一15:00的開會提醒
- 「每天晚上10點提醒我睡覺」→ 設置每天晚上22:00的睡覺提醒

### 查詢指令：
- 「查詢本月支出」→ 顯示當月所有支出記錄和總額
- 「查看飲食類別的花費」→ 顯示飲食類別的所有支出記錄和總額
- 「本週的收入有多少」→ 顯示本週所有收入記錄和總額

## 📊 專案進度

目前專案已經完成的功能：
1. LINE Bot 核心功能：包括自然語言記帳、提醒和查詢功能
2. Web 前端 PWA 基礎建設：包括用戶認證與基本導航
3. 帳戶管理頁面：支援新增、編輯和刪除帳戶
4. 分類管理頁面：支援自定義分類，包括支出和收入類別，可使用表情符號作為分類圖標

進行中的開發工作：
1. 交易記錄管理頁面優化
2. 提醒事項管理頁面
3. 報表與統計功能
4. 使用者體驗優化

## 本地開發與測試

### 設置開發環境

1. 複製 `.env.example` 為 `.env`，並填寫所需的環境變數：
   ```bash
   cp .env.example .env
   ```

2. 確保將 `FLASK_ENV` 設置為 `development`：
   ```
   FLASK_ENV=development
   ```

3. 安裝依賴：
   ```bash
   pip install -r requirements.txt
   ```

4. 初始化資料庫：
   ```bash
   python init_db.py
   ```

### 本地測試 Webhook

在開發環境中，Webhook 支持兩種測試方式：

#### 方法一：使用測試用戶ID (無需簽名)

您可以發送包含 `test_user_id` 的測試請求，系統會自動識別並處理，無需正確的簽名：

```bash
curl -X POST http://localhost:5000/api/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "events": [{
      "type": "message",
      "replyToken": "test-reply-token",
      "source": {
        "userId": "test_user_id",
        "type": "user"
      },
      "message": {
        "id": "test-message-1",
        "type": "text",
        "text": "記帳 100 午餐"
      }
    }]
  }'
```

#### 方法二：使用有效簽名

如果您想測試完整的簽名驗證流程，可以使用 `test_webhook_with_signature.py` 腳本：

```bash
python test_webhook_with_signature.py
```

該腳本會使用您在 `.env` 文件中設置的 `LINE_CHANNEL_SECRET` 生成有效的簽名，並發送測試請求。

#### 自動化測試

您還可以運行自動化測試：

```bash
pytest tests/
```

這將執行所有測試用例，包括 Webhook 功能測試。

### 生產環境考慮事項

在生產環境中，必須提供有效的 LINE Channel Secret 和 Access Token，並且所有請求都必須附帶有效的簽名。請參考 [LINE Messaging API 文檔](https://developers.line.biz/en/docs/messaging-api/) 了解更多詳情。

## 功能特色

### 提醒管理功能

提醒管理功能讓用戶可以通過網頁界面輕鬆管理所有提醒事項：

- **提醒列表查看**：根據狀態過濾顯示（未完成、已完成或全部）提醒事項
- **新增提醒**：創建新的提醒，可設置內容、日期時間、重複頻率和提前提醒時間
- **編輯提醒**：修改已有提醒的內容和設置
- **完成提醒**：將提醒標記為已完成
- **刪除提醒**：移除不需要的提醒

用戶可以在儀表板的"提醒事項"頁面使用這些功能，為生活和工作事項創建和管理各種提醒。 